name: ðŸ”” æ—¥çº¿ä¿¡å·æ‰«æ

on:
  # å®šæ—¶ä»»åŠ¡ï¼šæ¯ä¸ªäº¤æ˜“æ—¥ä¸‹åˆ3:30ï¼ˆåŒ—äº¬æ—¶é—´ï¼‰
  schedule:
    - cron: '30 7 * * 1-5'  # å‘¨ä¸€åˆ°å‘¨äº” 15:30 åŒ—äº¬æ—¶é—´ = 7:30 UTC
  
  # ä¹Ÿå¯ä»¥æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:

jobs:
  daily-scan:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
      - name: ðŸ“¥ Checkout ä»£ç 
        uses: actions/checkout@v3
        with:
          fetch-depth: 1
      
      - name: ðŸ è®¾ç½® Python çŽ¯å¢ƒ
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: ðŸ“¦ å®‰è£…ä¾èµ–
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: ðŸ” è¿è¡Œæ—¥çº¿æ‰«æ
        run: |
          cd stock_all
          python daily_scan.py --config config.yaml --watchlist ../output/watchlist.csv
        continue-on-error: true
      
      - name: ðŸ“Š æ˜¾ç¤ºæ‰«æç»“æžœ
        run: |
          echo "=== æ‰«æç»“æžœ ==="
          if [ -f output/daily_signals.csv ]; then
            SIGNAL_COUNT=$(tail -n +2 output/daily_signals.csv | wc -l)
            echo "ä»Šæ—¥è§¦å‘ä¿¡å·æ•°: $SIGNAL_COUNT"
            
            if [ $SIGNAL_COUNT -gt 0 ]; then
              echo ""
              echo "è§¦å‘ä¿¡å·çš„è‚¡ç¥¨:"
              cat output/daily_signals.csv
            fi
          else
            echo "ä»Šæ—¥æ— è§¦å‘ä¿¡å·"
          fi
      
      - name: ðŸ’¾ æäº¤ç»“æžœåˆ°ä»“åº“
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          git add output/
          
          if git diff --cached --quiet; then
            echo "â„¹ï¸  æ²¡æœ‰æ–°ä¿¡å·"
          else
            echo "ðŸ“ æäº¤æ‰«æç»“æžœ..."
            git commit -m "ðŸ¤– æ—¥çº¿ä¿¡å·æ‰«æ - $(date '+%Y-%m-%d %H:%M:%S')"
            git push
            echo "âœ… ç»“æžœå·²æŽ¨é€åˆ°ä»“åº“ï¼"
          fi
      
      - name: ðŸ“‹ ç”Ÿæˆè¿è¡ŒæŠ¥å‘Š
        if: always()
        run: |
          echo "## ðŸ”” æ—¥çº¿ä¿¡å·æ‰«ææŠ¥å‘Š" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**æ‰«ææ—¶é—´**: $(date)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ -f output/daily_signals.csv ]; then
            SIGNAL_COUNT=$(tail -n +2 output/daily_signals.csv | wc -l)
            echo "**è§¦å‘ä¿¡å·æ•°**: $SIGNAL_COUNT" >> $GITHUB_STEP_SUMMARY
            
            if [ $SIGNAL_COUNT -gt 0 ]; then
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "### ðŸ“ˆ è§¦å‘ä¿¡å·çš„è‚¡ç¥¨" >> $GITHUB_STEP_SUMMARY
              echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
              cat output/daily_signals.csv >> $GITHUB_STEP_SUMMARY
              echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "**çŠ¶æ€**: ä»Šæ—¥æ— è§¦å‘ä¿¡å·" >> $GITHUB_STEP_SUMMARY
          fi

